(function($){var $dateList=$("#dateList"),$fixedNav=$("#fixedNav"),$newRecordNav=$("#newRecordNav"),$userRecords=$("#userRecords"),$getMonthData=$("#getMonthData"),$recordDl=$("#recordDl"),$userStatusRender=$("#userStatusRender"),dateArr={"周天":0,"周一":1,"周二":2,"周三":3,"周四":4,"周五":5,"周六":6},status={1:"normal",2:"",10:"cd",11:"zt",12:"tx",13:"wc",15:"cc",16:"kg",20:"jb",50:"qj",8:"ls",9:"ls"},_date=new Date(),curDate=[_date.getFullYear(),_date.getMonth()+1],$recordTimes=$("#recordTimes"),record={init:function(){this.ajaxInit(curDate);this.getMonthData()},getMonthData:function(){var _this=this;$getMonthData.children("em").on("click",function(){var _T=this,y=curDate[0],m=curDate[1],timer=null;$(this).addClass("cur");if(m>1){curDate=[y,m-1]}else{curDate=[y-1,12]}_this.ajaxInit(curDate)});$getMonthData.children("span").on("click",function(){var _T=this,y=curDate[0],m=curDate[1],timer=null;if(y==_date.getFullYear()&&m==_date.getMonth()+1){return false}$(this).addClass("cur");if(m==12){curDate=[y+1,1]}else{curDate=[y,m+1]}_this.ajaxInit(curDate)})},ajaxInit:function(d){var _this=this;YI.getAjaxInfo({url:"/attend/index/record",method:"post",data:{'date': d[0] + '-' + d[1], 'staffid': staff_id, '_csrf-frontend':_csrf},weui:true,fn:function(data){$getMonthData.find("span,em").removeClass("cur");$getMonthData.children("i").html(d[0]+"年"+d[1]+"月").addClass("animated").addClass("flipInX");setTimeout(function(){$getMonthData.children("i").removeClass("animated").removeClass("flipInX")},500);var _d=data.data.reportlist,_i=data.data.staffinfo,_a=data.data.approves,dateList=[];var $userGender=$userRecords.find("div.a");$userRecords.find("img").attr("src",_i.we_avatar);$userGender.children("i").html(_i.we_name);$userRecords.find("div.b i").html(_i.department);if(_i.we_gender==1){$userGender.addClass("man")}else{$userGender.addClass("woman")}for(var i in _d){var obj={d:i,v:_d[i]};dateList.push(obj)}var newDateList=dateList.sort(function(a,b){return a.d-b.d});$.each(dateArr,function(i,e){if(i==new Date(newDateList[0]["d"]*1000).getWeek()){var lis="";for(var i=0,len=e;i<len;i++){lis+="<li><i></i></li>"}$dateList.html(lis);return false}});var _html="",_status1=_status8=_status9=_status10=_status11=_status12=_status13=_status15=_status16=_status20=_status50=0;$.each(newDateList,function(i,e){var h=(i+1)<10?("0"+(i+1)):(i+1);var xj="";function renderState(){if(e.v.auto_status){xj="xj"}if(e.v.day_status==1&&e.v.status==1){_html+='<li data-second="'+e.d+'" class="cur" data-check="'+e.v.check_list+'" data-date="'+h+'"><i><em class="'+xj+'"><del></del><span>'+h+'</span><ins class="xx"></ins><ins class="xx"></ins><b></b></em></i></li>'}else{_html+='<li data-second="'+e.d+'" class="cur" data-check="'+e.v.check_list+'" data-date="'+h+'"><i><em class="'+xj+'"><del></del><span>'+h+'</span><ins class="'+status[e.v.status]+'"></ins><ins class="'+(status[e.v.status1]?status[e.v.status1]:status[e.v.status])+'"></ins><b></b></em></i></li>'}}if(curDate[1]==(_date.getMonth()+1)){if(i+1<newDateList.length){renderState()}else{_html+='<li data-second="'+e.d+'" class="cur" data-check="'+e.v.check_list+'" data-date="'+h+'"><i><em class="today animated flipInY"><span>'+h+"</span><ins></ins><ins></ins><b></b></em></i></li>"}}else{renderState()}if(((new Date()).getTime()-e.d*1000)>86400000){if(i+1<=newDateList.length){if(e.v.day_status==1&&e.v.status==1){}else{if(e.v.status_list!=undefined){$.each(e.v.status_list,function(i,v){if(v==8||v==9){_status8++}else{var temp=("_status"+v);eval(temp+"++")}})}else{_status1++}}}}});$.each(_a,function(i,e){var temp=("_status"+i+"="+e);eval(temp)});$userStatusRender.find("li").eq(0).children("span").html(_status1);$userStatusRender.find("li").eq(1).children("span").html(_status10);$userStatusRender.find("li").eq(2).children("span").html(_status11);$userStatusRender.find("li").eq(3).children("span").html(_status16);$userStatusRender.find("li").eq(4).children("span").html(_status50);$userStatusRender.find("li").eq(5).children("span").html(_status12);$userStatusRender.find("li").eq(6).children("span").html(_status20);$userStatusRender.find("li").eq(7).children("span").html(_status15);$userStatusRender.find("li").eq(8).children("span").html(_status13);$userStatusRender.find("li").eq(9).children("span").html(_status8+_status9);$dateList.append(_html);var appendHtml="",monthNum=new Date(curDate[0],curDate[1],0).getDate(),minD=newDateList.length;for(var j=minD;j<monthNum;j++){appendHtml+='<li data-check=""><i><em>'+(j+1)+"<b></b></em></i></li>"}$dateList.append(appendHtml);_this.bindEvent(data.data.checkDay)}})},bindEvent:function(checkDay){$.each($dateList.find("li"),function(i,e){if($(e).find("ins.xx").length){$(e).find("i > em > span").css("color","#333")}});$dateList.find("li").on("click",function(){$(this).addClass("cur").siblings().removeClass("cur");$(this).find("b").show();$(this).siblings().find("b").hide();$(this).find("em").addClass("animated").addClass("flipInY");$(this).siblings().find("em").removeClass("animated").removeClass("flipInY");var _check=$(this).data("check");if(_check){var html='<dt class="t">打卡记录</dt>',_check=_check.split(",");$.each(_check,function(i,e){html+="<dd>"+e+"</dd>"});$recordDl.html(html)}else{$recordDl.html('<dt class="t">打卡记录</dt><dd>暂无数据</dd>')}$recordTimes.html("");var _second=$.trim($(this).data("second")),skip=0;if(_second){$.each(checkDay,function(i,e){if(e.date==_second){var _dateCheckin=new Date(e.checkin_time*1000),_dateCheckOut=new Date(e.checkout_time*1000),_a=_dateCheckin.getHours(),_b=_dateCheckin.getMinutes(),_c=_dateCheckin.getSeconds(),_d=_dateCheckOut.getHours(),_e=_dateCheckOut.getMinutes(),_f=_dateCheckOut.getSeconds(),_g=_h=_oo=_oi="";if(e.checkin_time==0){_a="—";_b=_c=""}else{_a=(_a<10)?("0"+_a):_a;_b=(_b<10)?("0"+_b):_b;_c=(_c<10)?("0"+_c):_c;_g=":"}if(e.checkout_time==0){_d="—";_e=_f=""}else{_d=(_d<10)?("0"+_d):_d;_e=(_e<10)?("0"+_e):_e;_f=(_f<10)?("0"+_f):_f;_h=":"}if(CHECK_LOG_OUTSIDE==e.checkin_type){_oi="(外勤)"}if(CHECK_LOG_OUTSIDE==e.checkout_type){_oo="(外勤)"}if(skip==0){$recordTimes.append("<dt>签到：<span>"+(_a+_g+_b+_g+_c)+_oi+"</span>，签退：<span>"+(_d+_h+_e+_h+_f)+_oo+"</span></dt>")}else{$recordTimes.append("<dd>签到：<span>"+(_a+_g+_b+_g+_c)+_oi+"</span>，签退：<span>"+(_d+_h+_e+_h+_f)+_oo+"</span></dd>")}skip++}else{}})}$recordTimes.show()});$.each($dateList.find("em"),function(i,e){if($(e).hasClass("today")){$(e).parents("li").trigger("click");return false}})}};$(function(){record.init()})})(Zepto);